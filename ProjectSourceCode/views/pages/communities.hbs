{{! Profile page wrapper with CU color bg}}
<section class="community-wrap">
    <div class="container">

        {{!-- Admin-only Add Community button (top left) --}}
        {{#if (eq user.role 'admin')}}
        <div class="row mt-4">
            <div class="col-12">
                <button class="btn btn-cu btn-sm add-community-btn" data-bs-toggle="modal"
                    data-bs-target="#newCommunityModal">
                    Add Community
                </button>
            </div>
        </div>
        {{/if}}

        {{!-- Main centered content --}}
        <div class="row justify-content-center mb-5 mt-4">
            <div class="col-12 col-md-10 col-lg-8">

                {{! Page title and back to home button}}
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <div class="d-flex align-items-center gap-3">
                        <div>
                            <h2>Your Communities</h2>
                        </div>
                    </div>
                    <a href="/home" class="btn btn-outline-cu btn-sm">Return to Home Page</a>
                </div>

                {{! Community card with community info and edit form}}
                {{#each communities}}
                <div class="card community-card shadow-sm mb-4" onmouseover="this.style.cursor='pointer'"
                    onmouseleave="this.style.cursor='default'"
                    onclick="window.location.href='/communities/{{community_id}}'">

                    <div class="card-body p-4 p-md-5">

                        {{!-- Community info + admin delete button --}}
                        <div class="d-flex justify-content-between align-items-start mb-4">
                            <div>
                                <div class="h5 mb-0 fw-bold">{{name}}</div>
                                <div class="fw-semibold small">Created at: {{formatDate created_at}}</div>
                                <div class="text-secondary small fw-bold">{{community_type}}</div>
                                <div class="text-secondary small">{{number_of_members}} Members</div>
                            </div>

                            {{!-- Admin-only Delete Community button --}}
                            {{#if (eq ../user.role 'admin')}}
                            <form action="/communities/{{community_id}}/delete" method="POST"
                                onclick="event.stopPropagation();"
                                onsubmit="return confirm('Are you sure you want to delete this community? This cannot be undone.');">
                                <button type="submit" class="btn btn-outline-danger btn-sm">
                                    Delete
                                </button>
                            </form>
                            {{/if}}
                        </div>

                    </div>
                </div>
                {{/each}}

                {{!-- Modal for creating a new community (admin only) --}}
                <div class="modal fade" id="newCommunityModal" tabindex="-1" aria-labelledby="newCommunityModalLabel"
                    aria-hidden="true">

                    <div class="modal-dialog">
                        <div class="modal-content">

                            <div class="modal-header">
                                <h5 class="modal-title" id="newCommunityModalLabel">Create a New Community</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                            </div>

                            <form action="/communities/new" method="POST">
                                <div class="modal-body">

                                    <div class="mb-3">
                                        <label for="name" class="form-label">Community Name</label>
                                        <input class="form-control" type="text" name="name" id="name" required>
                                    </div>

                                    <div class="mb-3">
                                        <label for="description" class="form-label">Description</label>
                                        <textarea class="form-control" name="description" id="description"
                                            required></textarea>
                                    </div>

                                </div>

                                <div class="modal-footer">
                                    <button type="button" class="btn btn-cancel-cu"
                                        data-bs-dismiss="modal">Cancel</button>
                                    <button type="submit" class="btn btn-cu">Confirm</button>
                                </div>
                            </form>

                        </div>
                    </div>
                </div>

                {{!-- Modal for "community already exists" --}}
                <div class="modal fade" id="communityExistsModal" tabindex="-1"
                    aria-labelledby="communityExistsModalLabel" aria-hidden="true">
                    <div class="modal-dialog modal-dialog-centered">
                        <div class="modal-content">

                            <div class="modal-header bg-warning">
                                <h5 class="modal-title" id="communityExistsModalLabel">Community Already Exists</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                            </div>

                            <div class="modal-body">
                                {{#if duplicateCommunity}}
                                <p>
                                    A community named <strong>{{duplicateCommunity.name}}</strong> already exists.
                                </p>
                                <p>
                                    Would you like to join this community instead?
                                </p>
                                {{else}}
                                <p>{{error}}</p>
                                {{/if}}
                            </div>

                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                                    Exit
                                </button>
                                {{#if duplicateCommunity}}
                                <button type="button" class="btn btn-cu" id="joinExistingCommunityBtn">
                                    Join Community
                                </button>
                                {{/if}}
                            </div>

                        </div>
                    </div>
                </div>

                {{#if showDuplicateModal}}
                <script>
                    document.addEventListener("DOMContentLoaded", function () {
                        var modalEl = document.getElementById('communityExistsModal');
                        if (!modalEl) return;

                        var modal = new bootstrap.Modal(modalEl);
                        modal.show();

                        var joinBtn = document.getElementById('joinExistingCommunityBtn');
                        if (joinBtn) {
                            joinBtn.addEventListener('click', async function () {
                                try {
                                    const resp = await fetch('/communities/{{duplicateCommunity.community_id}}/join', {
                                        method: 'POST',
                                        headers: {
                                            'Accept': 'application/json'
                                        }
                                    });

                                    if (resp.ok) {
                                        window.location.href = '/communities/{{duplicateCommunity.community_id}}';
                                    } else {
                                        modal.hide();
                                        alert('Could not join the community. Please try again.');
                                    }
                                } catch (err) {
                                    console.error('Error joining existing community:', err);
                                    modal.hide();
                                    alert('Could not join the community. Please try again.');
                                }
                            });
                        }
                    });
                </script>
                {{/if}}

                {{> footer}}
            </div>
        </div>
    </div>
</section>